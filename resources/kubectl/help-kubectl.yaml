apiVersion: apps/v1
kind: Deployment
metadata:
  name: help-keyman-com
  namespace: keyman
  labels:
    app: help-keyman-com
spec:
  replicas: 1
  selector:
    matchLabels:
      app: help-keyman-com
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: help-keyman-com
      name: help-keyman-com
      namespace: keyman
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - help-keyman-com
            topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 60
      containers:
      - name: app-php
        image: docker.dallas.languagetechnology.org/keyman/help-keyman-app
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        volumeMounts:
        - name: help-site-app
          mountPath: /var/www/html
          subPath: html
          readOnly: true
        readinessProbe:
          httpGet:
            path: /robots.txt
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 15
        livenessProbe:
          tcpSocket:
            port: 80

      - name: api
        image: alpine
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsGroup: 33
        env:
        - name: DEPLOY_KEY
          valueFrom:
            secretKeyRef:
              name: help-keyman-com
              key: deploy_key
        - name: SITE_GIT_BRANCH
          valueFrom:
            configMapKeyRef:
              name: help-keyman-com
              key: site-branch
        command: ["sh", "-c"]
        args: 
        - |
          set -e
          apk add git webhook
          exec webhook -verbose \
            -urlprefix=api \
            -template \
            -hooks=/webhooks/hooks.yaml
        ports:
        - containerPort: 9000
        volumeMounts:
        - name: webhooks
          mountPath: /webhooks
          readOnly: true
        - name: help-site-app
          mountPath: /mnt

      initContainers:
      - name: init-site-repo
        image: k8s.gcr.io/git-sync/git-sync:v3.6.2
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsUser: 0
          runAsGroup: 33
        env:
        - name: GIT_SYNC_BRANCH
          valueFrom:
            configMapKeyRef: {name: help-keyman-com, key: site-branch}
        args: [
          --repo=https://github.com/keymanapp/help.keyman.com.git,
          --sparse-checkout-file=/tmp/git/sparse-checkout.config,
          --one-time, --depth=1, --root=/mnt, --dest=html]
        volumeMounts:
        - name: help-site-app
          mountPath: /mnt
        - name: git-config
          mountPath: /tmp/git

      - name: init-site-vendoring
        image: busybox
        securityContext:
          runAsUser: 0
          runAsGroup: 33
        command: ['sh', '-c', 'ln -sf /var/www/vendor /mnt/html/vendor']
        volumeMounts:
        - name: help-site-app
          mountPath: /mnt

      volumes:
      - name: help-site-app
        persistentVolumeClaim:
          claimName: help-keyman-com
      - name: git-config
        configMap:
          name: help-keyman-com
          items:
          - key: git-sparse-checkout
            path: sparse-checkout.config
      - name: webhooks
        configMap:
          name: help-keyman-com
          items:
          - key: deployer
            path: deploy.sh
            mode: 365
          - key: webhooks
            path: hooks.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: help-keyman-com
  namespace: keyman
data:
  site-branch: staging
  git-sparse-checkout: |
    /*
    !.editorconfig
    !.github
    !composer.*
    !build.sh
    !Dockerfile
    !Readme.md
    !resources
    !web.config
  deployer: |
    #!/bin/sh
    git fetch && git reset --hard HEAD
  webhooks: |
    - id: deploy
      execute-command: /webhooks/deploy.sh
      command-working-directory: /mnt/html
      http-methods: [POST]
      trigger-rule:
        and:
        - or:
          - match:
              type: payload-hmac-sha256
              secret: '{{ getenv "DEPLOY_KEY" }}'
              parameter:
                source: header
                name: X-Hub-Signature-256
          - match:
              type: payload-hmac-sha1
              secret: '{{ getenv "DEPLOY_KEY" }}'
              parameter:
                source: header
                name: X-Hub-Signature
        - match:
            type: value
            value: push
            parameter:
              source: payload
              name: action
        - match:
            type: value
            value: 'refs/heads/{{getenv "SITE_GIT_BRANCH"}}'
            parameter:
              source: payload
              name: ref